var Dashboard=(function(){var Dashboard={};return Dashboard;})();Dashboard.Elements=(function(document){return{'chart':document.getElementById('chart'),'yAxis':document.getElementById('y-axis'),'legend':document.getElementById('legend'),'viewMode':document.getElementById('view-mode-select'),'viewFinder':document.getElementById('view-finder'),'viewFinderChart':document.getElementById('view-finder-chart'),'viewFinderBlurLeft':document.getElementById('blur-left'),'viewFinderBlurRight':document.getElementById('blur-right'),'viewFinderGrabLeft':document.querySelector('#blur-left .handle'),'viewFinderGrabRight':document.querySelector('#blur-right .handle'),'input':document.getElementById('input'),'random':document.getElementById('random'),'inputSubmit':document.getElementById('submit')}})(document);Dashboard.Controls=(function(Rickshaw){Controls={'stacked':Dashboard.Elements.viewMode.value==='stacked'};Dashboard.Elements.viewMode.addEventListener('change',function(e){Dashboard.Controls.stacked=Dashboard.Elements.viewMode.value==='stacked';Dashboard.Graph.draw();});Dashboard.Elements.random.addEventListener('click',function(e){Dashboard.Elements.input.value=JSON.stringify(Dashboard.Data.randomInput());});Dashboard.Elements.inputSubmit.addEventListener('click',function(e){Dashboard.Data.setInput(JSON.parse(Dashboard.Elements.input.value));Dashboard.Graph.draw();});return Controls;})(Rickshaw);Dashboard.Data=(function(Rickshaw,d3,document){var Data={'series':{'raw':[],'graph':[],'viewfinder':[]}};Data.randomInteger=function(min,max){return Math.floor(Math.random()*(max-min+1))+min;}
Data.randomIntegerSeries=function(len,min,max,vRatio){vRatio=typeof vRatio!=='undefined'?vRatio:0.15;var volatility=Math.round(Math.abs(max-min)*vRatio);for(var i=0,r=[],seed=Data.randomInteger(min,max);i<len;i++){r[i]=Data.randomInteger(Math.max(min,seed-volatility),Math.min(max,seed+volatility));seed=r[i];}
return r;}
Data.randomInput=function(length,start,interval){length=typeof length!=='undefined'?length:31;start=typeof start!=='undefined'?start:Math.floor(new Date().getTime()/1000)-(86400*31);interval=typeof interval!=='undefined'?interval:86400;var data={'data':[]},backend_ms=Data.randomIntegerSeries(length,200,600),frontend_ms=Data.randomIntegerSeries(length,800,2400);for(time=start,index=0;index<length;index++,time+=interval){data['data'][index]={'timestamp':time,'backend_ms':backend_ms[index],'frontend_ms':frontend_ms[index]};}
return data;}
Data.transform=function(arr,field){return arr.map(function(value){return{'x':value['timestamp'],'y':value[field]};});}
Data.validate=function(json){return json&&Object.prototype.toString.call(json.data)==='[object Array]'&&json.data.every(function(point){return!isNaN(point.timestamp)&&!isNaN(point.backend_ms)&&!isNaN(point.frontend_ms);});}
Data.palette=new Rickshaw.Color.Palette({scheme:'colorwheel'});Data.colors=[d3.rgb(Data.palette.color()),d3.rgb(Data.palette.color())];Data.parseInput=function(json){var data=json['data'];return[{name:'Frontend',color:'rgba('+Data.colors[1]['r']+','+Data.colors[1]['g']+','+Data.colors[1]['b']+',0.25)',stroke:'rgba('+Data.colors[1]['r']+','+Data.colors[1]['g']+','+Data.colors[1]['b']+',0.75)',data:Data.transform(data,'frontend_ms')},{name:'Backend',color:'rgba('+Data.colors[0]['r']+','+Data.colors[0]['g']+','+Data.colors[0]['b']+',0.25)',stroke:'rgba('+Data.colors[0]['r']+','+Data.colors[0]['g']+','+Data.colors[0]['b']+',0.75)',data:Data.transform(data,'backend_ms')}];}
Data.setInput=function(json){Dashboard.Elements.input.value=JSON.stringify(json);Data.series.graph=Data.parseInput(json);Data.series.viewfinder=Data.parseInput(json);return Data.series.raw=Data.parseInput(json);}
Data.filterDomain=function(start,end){var min=Math.min(start,end),max=Math.max(start,end),filtered=[];Data.series.raw.forEach(function(series){filtered.push({'data':series.data.filter(function(point){return point.x>=min&&point.x<=max;})});})
return filtered;}
return Data;})(Rickshaw,d3,document);Dashboard.Graph=(function(Rickshaw){var Graph={};Graph.draw=function(config){Dashboard.Data.series.graph.forEach(function(series,i){Graph.chart.series[i].data=series.data;});if(config){Graph.chart.configure(config);}
Graph.chart.renderer.unstack=!Dashboard.Controls.stacked;Graph.chart.render();}
Graph.init=function(){var input=Dashboard.Data.randomInput();var series=Dashboard.Data.setInput(input);Graph.chart=new Rickshaw.Graph({element:Dashboard.Elements.chart,width:770,height:320,padding:{'top':0.1,'bottom':0.1},renderer:'area',min:0,series:series,stroke:true});Graph.chart.renderer.unstack=!Dashboard.Controls.stacked;Graph.extras={axes:{x:new Rickshaw.Graph.Axis.Time({graph:Graph.chart}),y:new Rickshaw.Graph.Axis.Y({graph:Graph.chart,orientation:'left',tickFormat:Rickshaw.Fixtures.Number.formatKMBT,element:Dashboard.Elements.yAxis})},legend:new Rickshaw.Graph.Legend({element:Dashboard.Elements.legend,graph:Graph.chart}),hover:new Rickshaw.Graph.HoverDetail({graph:Graph.chart,yFormatter:function(y){return Math.round(y);}})}
Graph.extras.toggle=new Rickshaw.Graph.Behavior.Series.Toggle({graph:Graph.chart,legend:Graph.extras.legend});Graph.draw();}
Graph.init();return Graph;})(Rickshaw);Dashboard.ViewFinder=(function(Rickshaw,window){ViewFinder={'selected':[],'dragging':false,'domain':Dashboard.Graph.chart.dataDomain()};ViewFinder.draw=function(config){ViewFinder.domain=Dashboard.Graph.chart.dataDomain();Dashboard.Data.series.viewfinder.forEach(function(series,i){ViewFinder.chart.series[i].data=series.data;});if(config){ViewFinder.chart.configure(config);}
ViewFinder.chart.renderer.unstack=!Dashboard.Controls.stacked;ViewFinder.chart.render();}
Dashboard.Graph.chart.onUpdate(ViewFinder.draw);ViewFinder.init=function(){ViewFinder.chart=new Rickshaw.Graph({element:Dashboard.Elements.viewFinderChart,width:Dashboard.Graph.chart.width,min:Dashboard.Graph.chart.min,padding:Dashboard.Graph.chart.renderer.padding,stroke:Dashboard.Graph.chart.renderer.stroke,series:Dashboard.Data.series.viewfinder,renderer:'area',height:70,});ViewFinder.chart.renderer.unstack=!Dashboard.Controls.stacked;ViewFinder.chart.render();}
ViewFinder.updateChart=function(){Dashboard.Graph.chart.window.xMin=Dashboard.Elements.viewFinderGrabLeft.getAttribute('data-timestamp');Dashboard.Graph.chart.window.xMax=Dashboard.Elements.viewFinderGrabRight.getAttribute('data-timestamp');Dashboard.Graph.chart.update();}
ViewFinder.getOffset=function(el){var _x=0,_y=0,el=el||Dashboard.Elements.viewFinder;while(el&&!isNaN(el.offsetLeft)&&!isNaN(el.offsetTop)){_x+=el.offsetLeft-el.scrollLeft;_y+=el.offsetTop-el.scrollTop;el=el.offsetParent;}
return{top:_y,left:_x};}
ViewFinder.getTimestampFromOffset=function(x){var range=ViewFinder.domain[1]-ViewFinder.domain[0],width=Dashboard.Elements.viewFinder.clientWidth,percent=(x-ViewFinder.getOffset().left)/width;return Math.round(ViewFinder.domain[0]+(range*percent));}
ViewFinder.getTimestamp=function(handle){return ViewFinder.getTimestampFromOffset(ViewFinder.getOffset(handle).left);}
ViewFinder.drag=function(e){if(ViewFinder.dragging){ViewFinder.preventHighlight(e);var left=ViewFinder.dragging===Dashboard.Elements.viewFinderGrabLeft,other=left?Dashboard.Elements.viewFinderGrabRight:Dashboard.Elements.viewFinderGrabLeft,timestamp=ViewFinder.getTimestampFromOffset(e.pageX),domain=Dashboard.Data.filterDomain(timestamp,ViewFinder.getTimestamp(other));count=domain.reduce(function(last,current){return Math.min(last.data.length,current.data.length);});if(count>2){var width=Dashboard.Elements.viewFinder.clientWidth,offset=ViewFinder.getOffset(),percent=(e.pageX-offset.left)/width;ViewFinder.dragging.parentNode.style.width=(left?percent:(1-percent))*width+'px';ViewFinder.dragging.setAttribute('data-timestamp',timestamp);ViewFinder.updateChart();}}}
ViewFinder.preventHighlight=function(e){if(e.stopPropagation)e.stopPropagation();if(e.preventDefault)e.preventDefault();e.cancelBubble=true;e.returnValue=false;return false;}
Dashboard.Elements.viewFinderGrabLeft.addEventListener('mousedown',function(e){ViewFinder.dragging=Dashboard.Elements.viewFinderGrabLeft;ViewFinder.preventHighlight(e);});Dashboard.Elements.viewFinderGrabRight.addEventListener('mousedown',function(e){ViewFinder.dragging=Dashboard.Elements.viewFinderGrabRight;ViewFinder.preventHighlight(e);});Dashboard.Elements.viewFinder.addEventListener('mousemove',ViewFinder.drag);window.addEventListener('mouseup',function(e){ViewFinder.dragging=false;});ViewFinder.init();return ViewFinder;})(Rickshaw,window);